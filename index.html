span>` : ''}
                                    </div>
                                </div>
                                ${playersInRank.length > 0 ? `
                                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee;">
                                        ${playersInRank.map((player, playerIndex) => {
                                            const globalPosition = usersData.findIndex(u => u.uid === player.uid) + 1;
                                            return `
                                                <div style="margin: 5px 0; padding: 5px 8px; background: rgba(${rank.color.replace('#', '')}, 0.1); border-radius: 6px; font-size: 13px;">
                                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                                        <span style="font-weight: bold; color: ${rank.color};">#${globalPosition} ${player.displayName || 'Ù„Ù… ÙŠØªÙ… ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø§Ø³Ù…'}</span>
                                                        <span style="color: #666;">${player.points || 0} Ù†Ù‚Ø·Ø©</span>
                                                    </div>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('')}

                    <div class="modal-tip">
                        ðŸ’¡ Ø§ÙƒØ³Ø¨ Ù†Ù‚Ø§Ø· Ø£ÙƒØ«Ø± Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø±ØªØ¨ Ø£Ø¹Ù„Ù‰!
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // Load all users points
        window.loadAllUsersPoints = async function() {
            try {
                const usersRef = collection(db, 'users');
                const querySnapshot = await getDocs(usersRef);

                const validUsers = [];
                querySnapshot.forEach((doc) => {
                    const userData = doc.data();
                    if (userData.email && userData.email !== 'undefined') {
                        validUsers.push(userData);
                    }
                });

                validUsers.sort((a, b) => (b.points || 0) - (a.points || 0));

                const allUsersPointsList = document.getElementById('allUsersPointsList');
                allUsersPointsList.innerHTML = `
                    <div class="leaderboard">
                        <h4 style="text-align: center; color: #667eea; margin-bottom: 20px;">(${validUsers.length})</h4>
                        ${validUsers.map((user, index) => {
                            const isAdminUser = user.email === 'mahmod@gmail.com';
                            const rankInfo = getRankInfo(user.points || 0, isAdminUser);
                            const positionColors = ['#ffd700', '#c0c0c0', '#cd7f32'];
                            const positionColor = positionColors[index] || '#17a2b8';

                            return `
                                <div class="leaderboard-item" style="border-right-color: ${positionColor};">
                                    <div class="leaderboard-content">
                                        <div class="user-info">
                                            <div class="position">
                                                ${index + 1}${index === 0 ? ' ðŸ¥‡' : index === 1 ? ' ðŸ¥ˆ' : index === 2 ? ' ðŸ¥‰' : ''}
                                            </div>
                                            <div class="user-details">
                                                <h4>${user.displayName || 'Ù„Ù… ÙŠØªÙ… ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø§Ø³Ù…'}</h4>
                                                <div class="user-rank">
                                                    <span style="font-size: 18px;">${rankInfo.icon}</span>
                                                    <span style="color: ${rankInfo.color}; font-weight: bold; font-size: 14px;">${rankInfo.name}</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="user-points">
                                            ${user.points || 0} Ù†Ù‚Ø·Ø©
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            } catch (error) {
                showMessage('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: ' + error.message, 'error');
            }
        }

        // Refresh user points
        window.refreshUserPoints = async function() {
            if (!currentUser) {
                showMessage('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„', 'error');
                return;
            }

            try {
                const savedSession = localStorage.getItem('userSession');
                if (savedSession) {
                    const sessionData = JSON.parse(savedSession);

                    // Fetch fresh data from Firestore
                    const usersRef = collection(db, 'users');
                    const q = query(usersRef, where('displayName', '==', sessionData.displayName));
                    const querySnapshot = await getDocs(q);

                    if (!querySnapshot.empty) {
                        const userDoc = querySnapshot.docs[0];
                        const userData = userDoc.data();

                        const updatedUserInfo = {
                            uid: userData.uid,
                            email: userData.email,
                            displayName: userData.displayName,
                            points: userData.points || 0
                        };

                        localStorage.setItem('userSession', JSON.stringify(updatedUserInfo));
                        showProfile(updatedUserInfo);
                        showMessage('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ù‚Ø§Ø·! âœ¨');
                        return;
                    }
                }

                // For Firebase auth users
                if (auth.currentUser) {
                    const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
                    const userData = userDoc.exists() ? userDoc.data() : {};

                    showProfile({
                        uid: currentUser.uid,
                        email: currentUser.email,
                        displayName: userData.displayName || '',
                        points: userData.points || 0
                    });
                    showMessage('Points refreshed!');
                }
            } catch (error) {
                showMessage('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ù‚Ø§Ø·: ' + error.message, 'error');
            }
        }

        // Toggle admin sections
        window.toggleSection = function(sectionId) {
            const content = document.getElementById(sectionId + '-content');
            const icon = document.getElementById(sectionId + '-icon');

            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                icon.classList.remove('rotated');
                icon.textContent = 'â–¶';
            } else {
                content.classList.add('expanded');
                icon.classList.add('rotated');
                icon.textContent = 'â–¼';
            }
        }

        // Delete user function
        window.deleteUser = async function(identifier) {
            if (!isAdmin) {
                showMessage('Access denied.', 'error');
                return;
            }

            if (!confirm(`Delete user "${identifier}"?`)) {
                return;
            }

            try {
                const usersRef = collection(db, 'users');
                let q;

                if (identifier.includes('@')) {
                    q = query(usersRef, where('email', '==', identifier));
                } else {
                    q = query(usersRef, where('displayName', '==', identifier));
                }

                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    showMessage('User not found.', 'error');
                    return;
                }

                const userDoc = querySnapshot.docs[0];
                const userData = userDoc.data();

                if (userData.email === 'mahmod@gmail.com') {
                    showMessage('Cannot delete admin account.', 'error');
                    return;
                }

                await deleteDoc(doc(db, 'users', userDoc.id));

                showMessage('User deleted successfully!');

                if (document.getElementById('usersList').innerHTML) {
                    loadAllUsers();
                }
            } catch (error) {
                showMessage('Error deleting user: ' + error.message, 'error');
            }
        }

        // Logout function
        window.logout = async function() {
            try {
                if (auth.currentUser) {
                    await signOut(auth);
                } else {
                    currentUser = null;
                    localStorage.removeItem('userSession');
                    showLogin();
                }
                showMessage('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­! ðŸ‘‹');
            } catch (error) {
                showMessage(error.message, 'error');
            }
        }

        // Initialize
        window.addEventListener('load', () => {
            if (!checkSavedSession()) {
                showLogin();
            }
        });
    </script>
</body>
</html>
